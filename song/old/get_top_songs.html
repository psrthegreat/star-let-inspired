<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
    <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>I-Tunes audio</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">

        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/main.css">
        <script src="js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
        <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <!-- Add your site or application content here -->
        <div id="detector" class="vague">
            <canvas id="output"></canvas>
            <div class="pitch">
                <span id="pitch">--</span>Hz
            </div>
            <div class="note">
                <span id="note">--</span>
            </div>
            <div id="detune">
                <span id="detune_amt">--</span><span id="flat">cents &#9837;</span><span id="sharp">cents &#9839;</span>
            </div>
        </div>
        <div id="errorArea"></div>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>
			window.jQuery || document.write('<script src="js/vendor/jquery-1.9.1.min.js"><\/script>')
        </script>
        <script src="js/plugins.js"></script>
        <script src="js/main.js"></script>
        <script>
			/*$(document).ready(function() {
			makeRequest();
			return false;
			});
			*/

			//object that stores the pitches so far
			var songStats = function() {
				var pitches = [];
				this.addPitch = function(index) {
					if (!pitches[index]) {
						pitches[index] = 1;
					} else {
						pitches[index] += 1;
					}
				}

				this.getPitches = function() {
					console.log(pitches);
					return pitches;
				}

				this.getMean = function() {
					totalnotes = 0;
					numnotes = 0;
					for (var i = 0; i < pitches.length; i++) {
						if (pitches[i]) {
							totalnotes += i * pitches[i];
							numnotes += pitches[i];
						}
					}
					return totalnotes / numnotes;
				}
			};

			// create the HTML5 audio element
			var audio = new Audio();
			var buflen = 1024;
			var buf = new Uint8Array(1024);
			var MINVAL = 134;
			var stats = new songStats();
			var audioContext = new webkitAudioContext();
			var analyser = audioContext.createAnalyser();
			analyser.fftSize = 2048;
			var sourceNode;
			document.body.appendChild(audio);
			window.addEventListener('load', function(e) {
				sourceNode = audioContext.createMediaElementSource(audio);
				sourceNode.connect(analyser);
				analyser.connect(audioContext.destination);
				makeRequest();
			}, false);

			// 128 == zero.  MINVAL is the "minimum detected signal" level.
			function findNextPositiveZeroCrossing(start) {
				var i = Math.ceil(start);
				var last_zero = -1;
				// advance until we're zero or negative
				while (i < buflen && (buf[i] > 128 ))
				i++;
				if (i >= buflen)
					return -1;

				// advance until we're above MINVAL, keeping track of last zero.
				while (i < buflen && (( t = buf[i]) < MINVAL )) {
					if (t >= 128) {
						if (last_zero == -1)
							last_zero = i;
					} else
						last_zero = -1;
					i++;
				}

				// we may have jumped over MINVAL in one sample.
				if (last_zero == -1)
					last_zero = i;

				if (i == buflen)// We didn't find any more positive zero crossings
					return -1;

				// The first sample might be a zero.  If so, return it.
				if (last_zero == 0)
					return 0;

				// Otherwise, the zero might be between two values, so we need to scale it.

				var t = (128 - buf[last_zero - 1] ) / (buf[last_zero] - buf[last_zero - 1]);
				return last_zero + t;
			}

			var updatePitch = function() {
				var cycles = new Array;
				analyser.getByteTimeDomainData(buf);
				var i = 0;
				// find the first point
				var last_zero = findNextPositiveZeroCrossing(0);
				var n = 0;
				// keep finding points, adding cycle lengths to array
				while (last_zero != -1) {
					var next_zero = findNextPositiveZeroCrossing(last_zero + 1);
					if (next_zero > -1)
						cycles.push(next_zero - last_zero);
					last_zero = next_zero;

					n++;
					if (n > 1000)
						break;
				}

				// 1?: average the array
				var num_cycles = cycles.length;
				var sum = 0;
				var pitch = 0;

				for (var i = 0; i < num_cycles; i++) {
					sum += cycles[i];
				}

				if (num_cycles) {
					sum /= num_cycles;
					pitch = audioContext.sampleRate / sum;
				}

				// confidence = num_cycles / num_possible_cycles = num_cycles / (audioContext.sampleRate/)
				var confidence = ( num_cycles ? ((num_cycles / (pitch * buflen / audioContext.sampleRate)) * 100) : 0);

				// possible other approach to confidence: sort the array, take the median; go through the array and compute the average deviation
				var detectorElem = document.getElementById("detector");
				var canvasElem = document.getElementById("output");
				var pitchElem = document.getElementById("pitch");
				var noteElem = document.getElementById("note");
				var detuneElem = document.getElementById("detune");
				var detuneAmount = document.getElementById("detune_amt");
				
				if (num_cycles == 0) {
					pitchElem.innerText = "--";
					noteElem.innerText = "-";
					detuneElem.className = "";
					detuneAmount.innerText = "--";
					console.log('here daym');
				} else {
					if (true) {
					    console.log("Cycles: " + num_cycles + " - average length: " + sum + " - pitch: " + pitch + "Hz " + " - note: " + noteFromPitch(pitch) + " - confidence: " + confidence + "% ");
 						pitchElem.innerText = Math.floor(pitch);
						var note = noteFromPitch(pitch);
						var detune = centsOffFromPitch(pitch, note);
						if (Math.abs(detune) < 8) {
							stats.addPitch(noteFromPitch(pitch));
							noteElem.innerText = noteStrings[note % 12];

							detuneElem.className = "";
							detuneAmount.innerText = "--";
						} else {

							if (detune < 0)
								detuneElem.className = "flat";
							else
								detuneElem.className = "sharp";
							detuneAmount.innerText = Math.abs(detune);
						}
					}
				}
				rafID = window.webkitRequestAnimationFrame(updatePitch);
			}
			var noteStrings = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

			function noteFromPitch(frequency) {
				var noteNum = 12 * (Math.log(frequency / 440) / Math.log(2) );
				return Math.round(noteNum) + 69;
			}

			function frequencyFromNoteNumber(note) {
				return 440 * Math.pow(2, (note - 69) / 12);
			}

			function centsOffFromPitch(frequency, note) {
				return Math.floor(1200 * Math.log(frequency / frequencyFromNoteNumber(note)) / Math.log(2));
			}

			function unsuccessfulRequestMessage() {
				$("#errorArea").html("Oops. Something went wrong.");
			}

			var myBuffer = function(array) {
				var buffer = array;
				var count = array.length;
				var cur = 0;
				this.getNextSong = function() {
					if (cur < count) {
						var nextSong = buffer[cur];
						cur++;
						return nextSong;
					}
					return null;
				}

				this.getCurrentSong = function() {
					return buffer[cur];
				}

				this.printAll = function() {
					for (var i = 0; i < count; i++) {
						console.log(buffer[i].title);
					}
				}
			}
			function playNext(arr) {
				var next = arr.getNextSong();
				console.log(next);
				if (next == null)
					return null;
				playSong(next);
			}

			function playSong(song) {
				$("#errorArea").html("");
				var url = song.preview;
				console.log(url);
				audio.src = url;
				audio.load();
				audio.play();
			}

			function makeRequest() {
				$.ajax({
					url : "https://itunes.apple.com/us/rss/topsongs/limit=1/xml",
					dataType : 'xml',
				}).done(function(xml) {
					var array = [];
					$(xml).find('entry').each(function() {
						console.log(this);
						var element = {};
						element.id = $(this).find('id').attr('im:id');
						element.title = $(this).find('title').text();
						element.genre = $(this).children('category').attr('label');
						element.preview = $(this).children('link[title="Preview"]').attr('href');
						array.push(element);
					});
					console.log(array);
					console.log(array.length);
					arr = new myBuffer(array);
					arr.printAll();

					var first = arr.getNextSong();
					playSong(first);

					console.log(audio);
					console.log(audioContext);
					updatePitch(stats);

					//$(audio).bind('ended', buf, playNext);

					$(audio).bind('ended', function() {
						stats.getPitches();
						console.log((stats.getMean()));

						if (!playNext(arr)) {
							sourceNode = null;
							analyser = null;
							isPlaying = false;
							webkitCancelAnimationFrame(rafID);
						}
					});

				}).fail(function(data) {
					unsuccessfulRequestMessage();
				});
			}

        </script>
    </body>
</html>